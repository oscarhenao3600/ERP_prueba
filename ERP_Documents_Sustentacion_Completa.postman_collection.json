{
	"info": {
		"_postman_id": "erp-documents-sustentacion-completa",
		"name": "üöÄ ERP Documents - Sustentaci√≥n Completa con Autenticaci√≥n",
		"description": "Colecci√≥n completa para sustentaci√≥n del sistema ERP con autenticaci√≥n implementada",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "üîê Autenticaci√≥n",
			"item": [
				{
					"name": "üîë Login",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"username\": \"sustentador\",\n  \"password\": \"sustentacion123\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/auth/login/",
							"host": ["{{base_url}}"],
							"path": ["api", "auth", "login", ""]
						},
						"description": "Iniciar sesi√≥n y obtener token de autenticaci√≥n."
					},
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    pm.environment.set('auth_token', response.token);",
									"    pm.environment.set('user_id', response.user.id);",
									"    pm.environment.set('company_id', response.user.company.id);",
									"    console.log('‚úÖ Token guardado:', response.token);",
									"    console.log('‚úÖ User ID:', response.user.id);",
									"    console.log('‚úÖ Company ID:', response.user.company.id);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					]
				},
				{
					"name": "üë§ Perfil de Usuario",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/auth/profile/",
							"host": ["{{base_url}}"],
							"path": ["api", "auth", "profile", ""]
						},
						"description": "Obtener informaci√≥n del perfil del usuario autenticado."
					}
				},
				{
					"name": "üö™ Logout",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/auth/logout/",
							"host": ["{{base_url}}"],
							"path": ["api", "auth", "logout", ""]
						},
						"description": "Cerrar sesi√≥n del usuario."
					}
				}
			],
			"description": "Endpoints de autenticaci√≥n del sistema."
		},
		{
			"name": "üè¢ Gesti√≥n de Empresas",
			"item": [
				{
					"name": "üìã Listar Empresas",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/companies/",
							"host": ["{{base_url}}"],
							"path": ["api", "companies", ""]
						},
						"description": "Lista todas las empresas disponibles para el usuario autenticado."
					}
				},
				{
					"name": "üìä Estad√≠sticas de Empresa",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/companies/{{company_id}}/stats/",
							"host": ["{{base_url}}"],
							"path": ["api", "companies", "{{company_id}}", "stats", ""]
						},
						"description": "Obtiene estad√≠sticas detalladas de la empresa del usuario."
					}
				},
				{
					"name": "üë• Usuarios de la Empresa",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/companies/{{company_id}}/users/",
							"host": ["{{base_url}}"],
							"path": ["api", "companies", "{{company_id}}", "users", ""]
						},
						"description": "Lista todos los usuarios de la empresa del usuario autenticado."
					}
				}
			],
			"description": "Operaciones de gesti√≥n de empresas."
		},
		{
			"name": "üè≠ Gesti√≥n de Entidades",
			"item": [
				{
					"name": "üìã Listar Tipos de Entidad",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/entity-types/",
							"host": ["{{base_url}}"],
							"path": ["api", "entity-types", ""]
						},
						"description": "Lista todos los tipos de entidades disponibles."
					}
				},
				{
					"name": "üìã Listar Entidades",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/entities/",
							"host": ["{{base_url}}"],
							"path": ["api", "entities", ""]
						},
						"description": "Lista todas las entidades del usuario autenticado."
					}
				},
				{
					"name": "‚ûï Crear Entidad - Veh√≠culo",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"company_id\": \"{{company_id}}\",\n  \"entity_type\": \"vehicle\",\n  \"external_id\": \"VEH-DEMO-{{$timestamp}}\",\n  \"name\": \"Veh√≠culo Demo Sustentaci√≥n\",\n  \"metadata\": {\n    \"brand\": \"Toyota\",\n    \"model\": \"Corolla\",\n    \"year\": 2023,\n    \"plate\": \"DEM-{{$timestamp}}\",\n    \"color\": \"Blanco\"\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/entities/",
							"host": ["{{base_url}}"],
							"path": ["api", "entities", ""]
						},
						"description": "Crea una nueva entidad de tipo veh√≠culo."
					},
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 201) {",
									"    const response = pm.response.json();",
									"    pm.environment.set('entity_id', response.id);",
									"    console.log('‚úÖ Entity ID guardado:', response.id);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					]
				}
			],
			"description": "Operaciones de gesti√≥n de entidades."
		},
		{
			"name": "üìÑ Gesti√≥n de Documentos",
			"item": [
				{
					"name": "üìã Listar Documentos",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/documents/",
							"host": ["{{base_url}}"],
							"path": ["api", "documents", ""]
						},
						"description": "Lista todos los documentos del usuario autenticado."
					}
				},
				{
					"name": "üì§ Obtener URL de Subida",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"bucket_key\": \"companies/{{company_id}}/vehicles/{{entity_id}}/docs/documento-demo-{{$timestamp}}.pdf\",\n  \"mime_type\": \"application/pdf\",\n  \"expiration_hours\": 1\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/documents/upload_url/",
							"host": ["{{base_url}}"],
							"path": ["api", "documents", "upload_url", ""]
						},
						"description": "Obtiene una URL pre-firmada para subir un archivo al cloud storage."
					}
				},
				{
					"name": "‚ûï Crear Documento - Con Validaci√≥n",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"company_id\": \"{{company_id}}\",\n  \"entity\": {\n    \"entity_type\": \"vehicle\",\n    \"entity_id\": \"VEH-DEMO-{{$timestamp}}\"\n  },\n  \"document\": {\n    \"name\": \"SOAT Demo {{$timestamp}}.pdf\",\n    \"mime_type\": \"application/pdf\",\n    \"size_bytes\": 245760,\n    \"bucket_key\": \"companies/{{company_id}}/vehicles/{{entity_id}}/docs/soat-demo-{{$timestamp}}.pdf\",\n    \"file_hash\": \"{{$randomAlphaNumeric}}\",\n    \"description\": \"SOAT del veh√≠culo demo para sustentaci√≥n\",\n    \"tags\": [\"seguro\", \"vehiculo\", \"soat\", \"2024\"]\n  },\n  \"validation_flow\": {\n    \"enabled\": true,\n    \"steps\": [\n      {\n        \"order\": 1,\n        \"approver_user_id\": \"{{user_id}}\"\n      },\n      {\n        \"order\": 2,\n        \"approver_user_id\": \"{{user_id}}\"\n      }\n    ]\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/documents/",
							"host": ["{{base_url}}"],
							"path": ["api", "documents", ""]
						},
						"description": "Crea un nuevo documento con flujo de validaci√≥n jer√°rquico."
					},
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 201) {",
									"    const response = pm.response.json();",
									"    pm.environment.set('document_id', response.id);",
									"    console.log('‚úÖ Document ID guardado:', response.id);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					]
				},
				{
					"name": "üîç Detalle de Documento",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/documents/{{document_id}}/",
							"host": ["{{base_url}}"],
							"path": ["api", "documents", "{{document_id}}", ""]
						},
						"description": "Obtiene informaci√≥n detallada de un documento espec√≠fico."
					}
				},
				{
					"name": "üìä Estado de Validaci√≥n",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/documents/{{document_id}}/validation_status/",
							"host": ["{{base_url}}"],
							"path": ["api", "documents", "{{document_id}}", "validation_status", ""]
						},
						"description": "Obtiene el estado detallado del flujo de validaci√≥n de un documento."
					}
				}
			],
			"description": "Operaciones de gesti√≥n de documentos."
		},
		{
			"name": "‚úÖ Flujo de Validaci√≥n",
			"item": [
				{
					"name": "‚è≥ Documentos Pendientes de Aprobaci√≥n",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/documents/pending_approvals/",
							"host": ["{{base_url}}"],
							"path": ["api", "documents", "pending_approvals", ""]
						},
						"description": "Lista todos los documentos pendientes de aprobaci√≥n."
					}
				},
				{
					"name": "‚úÖ Aprobar Documento",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"actor_user_id\": \"{{user_id}}\",\n  \"reason\": \"Documento cumple con todos los requisitos establecidos. SOAT vigente y legible.\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/documents/{{document_id}}/approve/",
							"host": ["{{base_url}}"],
							"path": ["api", "documents", "{{document_id}}", "approve", ""]
						},
						"description": "Aprueba un documento en el flujo de validaci√≥n jer√°rquico."
					}
				},
				{
					"name": "‚ùå Rechazar Documento",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"actor_user_id\": \"{{user_id}}\",\n  \"reason\": \"Documento ilegible. La imagen est√° borrosa y no se puede verificar la informaci√≥n.\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/documents/{{document_id}}/reject/",
							"host": ["{{base_url}}"],
							"path": ["api", "documents", "{{document_id}}", "reject", ""]
						},
						"description": "Rechaza un documento en el flujo de validaci√≥n (acci√≥n terminal)."
					}
				}
			],
			"description": "Operaciones del flujo de validaci√≥n jer√°rquico."
		},
		{
			"name": "üìä Reportes y Estad√≠sticas",
			"item": [
				{
					"name": "üìà Dashboard General",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/companies/{{company_id}}/stats/",
							"host": ["{{base_url}}"],
							"path": ["api", "companies", "{{company_id}}", "stats", ""]
						},
						"description": "Obtiene estad√≠sticas generales de la empresa para el dashboard."
					}
				},
				{
					"name": "üìä Estad√≠sticas de Documentos",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Token {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/documents/approval_stats/",
							"host": ["{{base_url}}"],
							"path": ["api", "documents", "approval_stats", ""]
						},
						"description": "Obtiene estad√≠sticas detalladas de aprobaci√≥n de documentos."
					}
				}
			],
			"description": "Reportes y estad√≠sticas del sistema."
		},
		{
			"name": "üé≠ Escenarios de Sustentaci√≥n",
			"item": [
				{
					"name": "üéØ Escenario Completo: Flujo de Documento",
					"item": [
						{
							"name": "1Ô∏è‚É£ Login",
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n  \"username\": \"sustentador\",\n  \"password\": \"sustentacion123\"\n}"
								},
								"url": {
									"raw": "{{base_url}}/api/auth/login/",
									"host": ["{{base_url}}"],
									"path": ["api", "auth", "login", ""]
								}
							},
							"event": [
								{
									"listen": "test",
									"script": {
										"exec": [
											"if (pm.response.code === 200) {",
											"    const response = pm.response.json();",
											"    pm.environment.set('auth_token', response.token);",
											"    pm.environment.set('user_id', response.user.id);",
											"    pm.environment.set('company_id', response.user.company.id);",
											"    console.log('‚úÖ Login exitoso');",
											"}"
										],
										"type": "text/javascript"
									}
								}
							]
						},
						{
							"name": "2Ô∏è‚É£ Crear Entidad",
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Authorization",
										"value": "Token {{auth_token}}"
									},
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n  \"company_id\": \"{{company_id}}\",\n  \"entity_type\": \"vehicle\",\n  \"external_id\": \"VEH-SCENARIO-{{$timestamp}}\",\n  \"name\": \"Veh√≠culo Escenario Completo\",\n  \"metadata\": {\n    \"brand\": \"Ford\",\n    \"model\": \"Focus\",\n    \"year\": 2022,\n    \"plate\": \"ESC-{{$timestamp}}\",\n    \"color\": \"Azul\"\n  }\n}"
								},
								"url": {
									"raw": "{{base_url}}/api/entities/",
									"host": ["{{base_url}}"],
									"path": ["api", "entities", ""]
								}
							},
							"event": [
								{
									"listen": "test",
									"script": {
										"exec": [
											"if (pm.response.code === 201) {",
											"    const response = pm.response.json();",
											"    pm.environment.set('entity_id', response.id);",
											"    console.log('‚úÖ Entidad creada');",
											"}"
										],
										"type": "text/javascript"
									}
								}
							]
						},
						{
							"name": "3Ô∏è‚É£ Crear Documento con Validaci√≥n",
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Authorization",
										"value": "Token {{auth_token}}"
									},
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n  \"company_id\": \"{{company_id}}\",\n  \"entity\": {\n    \"entity_type\": \"vehicle\",\n    \"entity_id\": \"VEH-SCENARIO-{{$timestamp}}\"\n  },\n  \"document\": {\n    \"name\": \"SOAT Escenario Completo.pdf\",\n    \"mime_type\": \"application/pdf\",\n    \"size_bytes\": 300000,\n    \"bucket_key\": \"companies/{{company_id}}/vehicles/{{entity_id}}/docs/soat-escenario-completo.pdf\",\n    \"file_hash\": \"scenario{{$timestamp}}hash\",\n    \"description\": \"SOAT del veh√≠culo del escenario completo\",\n    \"tags\": [\"escenario\", \"soat\", \"validacion\"]\n  },\n  \"validation_flow\": {\n    \"enabled\": true,\n    \"steps\": [\n      {\n        \"order\": 1,\n        \"approver_user_id\": \"{{user_id}}\"\n      },\n      {\n        \"order\": 2,\n        \"approver_user_id\": \"{{user_id}}\"\n      }\n    ]\n  }\n}"
								},
								"url": {
									"raw": "{{base_url}}/api/documents/",
									"host": ["{{base_url}}"],
									"path": ["api", "documents", ""]
								}
							},
							"event": [
								{
									"listen": "test",
									"script": {
										"exec": [
											"if (pm.response.code === 201) {",
											"    const response = pm.response.json();",
											"    pm.environment.set('document_id', response.id);",
											"    console.log('‚úÖ Documento creado con validaci√≥n');",
											"}"
										],
										"type": "text/javascript"
									}
								}
							]
						},
						{
							"name": "4Ô∏è‚É£ Verificar Estado Pendiente",
							"request": {
								"method": "GET",
								"header": [
									{
										"key": "Authorization",
										"value": "Token {{auth_token}}"
									}
								],
								"url": {
									"raw": "{{base_url}}/api/documents/{{document_id}}/validation_status/",
									"host": ["{{base_url}}"],
									"path": ["api", "documents", "{{document_id}}", "validation_status", ""]
								}
							},
							"event": [
								{
									"listen": "test",
									"script": {
										"exec": [
											"if (pm.response.code === 200) {",
											"    console.log('‚úÖ Estado de validaci√≥n verificado');",
											"}"
										],
										"type": "text/javascript"
									}
								}
							]
						},
						{
							"name": "5Ô∏è‚É£ Aprobar Documento",
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Authorization",
										"value": "Token {{auth_token}}"
									},
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n  \"actor_user_id\": \"{{user_id}}\",\n  \"reason\": \"Documento aprobado en escenario completo - cumple requisitos\"\n}"
								},
								"url": {
									"raw": "{{base_url}}/api/documents/{{document_id}}/approve/",
									"host": ["{{base_url}}"],
									"path": ["api", "documents", "{{document_id}}", "approve", ""]
								}
							},
							"event": [
								{
									"listen": "test",
									"script": {
										"exec": [
											"if (pm.response.code === 200) {",
											"    console.log('‚úÖ Documento aprobado exitosamente');",
											"}"
										],
										"type": "text/javascript"
									}
								}
							]
						},
						{
							"name": "6Ô∏è‚É£ Verificar Estado Final",
							"request": {
								"method": "GET",
								"header": [
									{
										"key": "Authorization",
										"value": "Token {{auth_token}}"
									}
								],
								"url": {
									"raw": "{{base_url}}/api/documents/{{document_id}}/validation_status/",
									"host": ["{{base_url}}"],
									"path": ["api", "documents", "{{document_id}}", "validation_status", ""]
								}
							},
							"event": [
								{
									"listen": "test",
									"script": {
										"exec": [
											"if (pm.response.code === 200) {",
											"    console.log('‚úÖ Estado final verificado - ESCENARIO COMPLETO EXITOSO');",
											"}"
										],
										"type": "text/javascript"
									}
								}
							]
						}
					],
					"description": "Escenario completo: Login ‚Üí Crear Entidad ‚Üí Crear Documento ‚Üí Aprobar ‚Üí Verificar estado"
				}
			],
			"description": "Escenarios completos para la sustentaci√≥n."
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Script global para manejo de variables din√°micas",
					"console.log('üöÄ Iniciando request para:', pm.request.url);"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Tests globales para validar respuestas",
					"pm.test('Response time is less than 5000ms', function () {",
					"    pm.expect(pm.response.responseTime).to.be.below(5000);",
					"});",
					"",
					"pm.test('Response has proper headers', function () {",
					"    if (pm.request.url.toString().includes('/api/')) {",
					"        pm.expect(pm.response.headers.get('Content-Type')).to.include('application/json');",
					"    }",
					"});"
				]
			}
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:8000",
			"type": "string"
		}
	]
}
